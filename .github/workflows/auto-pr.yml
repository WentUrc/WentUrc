name: Auto Submit PR to Upstream

on:
  push:
    branches:
      - main
      # å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–åˆ†æ”¯

env:
  UPSTREAM_REPO: 'WentUrc/WentUrc'  # ä¸Šæ¸¸ä»“åº“ï¼Œæ ¼å¼ï¼šowner/repo
  UPSTREAM_BRANCH: 'main'  # ä¸Šæ¸¸ä»“åº“çš„ç›®æ ‡åˆ†æ”¯
  PR_BRANCH_PREFIX: 'sync-from-fork'  # PRåˆ†æ”¯å‰ç¼€

jobs:
  auto-upstream-pr:
    runs-on: ubuntu-latest
    if: github.event.pusher.name != 'IGCrystal-G'  # é¿å…botè§¦å‘çš„å¾ªç¯
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        token: ${{ secrets.UPSTREAM_TOKEN }}

    - name: Setup Git
      run: |
        git config --global user.name "IGCrystal-G"
        git config --global user.email "cacheigcrystal@gmail.com"

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
        git fetch upstream

    - name: Check if upstream is ahead
      id: check_upstream
      run: |
        # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°çš„æäº¤
        UPSTREAM_COMMITS=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }})
        echo "upstream_commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
        
        if [ "$UPSTREAM_COMMITS" -gt 0 ]; then
          echo "Upstream has $UPSTREAM_COMMITS new commits. Merging upstream changes first."
          git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit || {
            echo "Merge conflict detected. Please resolve manually."
            exit 1
          }
          git push origin ${{ github.ref_name }}
        fi

    - name: Generate branch name
      id: branch_name
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="${{ env.PR_BRANCH_PREFIX }}-${{ github.ref_name }}-${TIMESTAMP}"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

    - name: Create and push feature branch
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰UPSTREAM_TOKEN
        if [ -z "${{ secrets.UPSTREAM_TOKEN }}" ]; then
          echo "âŒ UPSTREAM_TOKEN secret not found. Please add it to repository secrets."
          exit 1
        fi
        
        # åŸºäºå½“å‰åˆ†æ”¯åˆ›å»ºæ–°åˆ†æ”¯
        git checkout -b ${{ steps.branch_name.outputs.branch_name }}
        
        # ä½¿ç”¨UPSTREAM_TOKENæ¨é€åˆ°ä¸Šæ¸¸ä»“åº“
        git remote remove upstream
        git remote add upstream https://${{ secrets.UPSTREAM_TOKEN }}@github.com/${{ env.UPSTREAM_REPO }}.git
        git push upstream ${{ steps.branch_name.outputs.branch_name }}

    - name: Get commit information
      id: commit_info
      run: |
        # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
        git fetch upstream ${{ env.UPSTREAM_BRANCH }}

        LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        COMMIT_COUNT=$(git rev-list --count upstream/${{ env.UPSTREAM_BRANCH }}..${{ github.ref_name }})
        
        echo "last_commit_msg=$LAST_COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "last_commit_author=$LAST_COMMIT_AUTHOR" >> $GITHUB_OUTPUT
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

    - name: Create Pull Request
      id: create_pr
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.UPSTREAM_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const upstreamRepo = '${{ env.UPSTREAM_REPO }}'.split('/');
          const upstreamOwner = upstreamRepo[0];
          const upstreamRepoName = upstreamRepo[1];
          
          // æ„å»ºPRæ ‡é¢˜å’Œæè¿°
          const commitCount = '${{ steps.commit_info.outputs.commit_count }}';
          const lastCommitMsg = '${{ steps.commit_info.outputs.last_commit_msg }}';
          const lastCommitAuthor = '${{ steps.commit_info.outputs.last_commit_author }}';
          const sourceBranch = '${{ github.ref_name }}';
          const branchName = '${{ steps.branch_name.outputs.branch_name }}';
          
          let title, body;
          
          if (commitCount === '1') {
            title = `${lastCommitMsg}`;
          } else {
            title = `Sync ${commitCount} commits from ${owner}/${repo}:${sourceBranch}`;
          }
          
          body = `## ğŸ”„ è‡ªåŠ¨åŒæ­¥ PR
          
          **æºä»“åº“**: ${owner}/${repo}
          **æºåˆ†æ”¯**: ${sourceBranch}
          **åŒæ­¥åˆ†æ”¯**: ${branchName}
          **æäº¤æ•°é‡**: ${commitCount}
          **æœ€æ–°æäº¤**: ${lastCommitMsg}
          **æœ€æ–°ä½œè€…**: ${lastCommitAuthor}
          
          ### ğŸ“ å˜æ›´è¯´æ˜
          æ­¤PRè‡ªåŠ¨åŒæ­¥äº†æ¥è‡ªforkä»“åº“çš„${commitCount}ä¸ªæäº¤ã€‚
          
          ### ğŸ” éªŒè¯æ¸…å•
          - [ ] ä»£ç å®¡æŸ¥é€šè¿‡
          - [ ] æµ‹è¯•é€šè¿‡
          - [ ] æ–‡æ¡£æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰
          - [ ] æ— ç ´åæ€§å˜æ›´
          
          ### ğŸ“Š æäº¤å†å²
          `;
          
          // æ·»åŠ æäº¤å†å²
          const commits = await github.rest.repos.compareCommits({
            owner: upstreamOwner,
            repo: upstreamRepoName,
            base: '${{ env.UPSTREAM_BRANCH }}',
            head: branchName
          });
          
          commits.data.commits.forEach(commit => {
            const shortSha = commit.sha.substring(0, 7);
            const message = commit.commit.message.split('\n')[0];
            const author = commit.commit.author.name;
            body += `\n- \`${shortSha}\` ${message} (@${author})`;
          });
          
          body += `\n\n---
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºäº ${new Date().toISOString()}*`;
          
          // åˆ›å»ºPR
          try {
            const pr = await github.rest.pulls.create({
              owner: upstreamOwner,
              repo: upstreamRepoName,
              title: title,
              head: branchName,
              base: '${{ env.UPSTREAM_BRANCH }}',
              body: body,
              maintainer_can_modify: true
            });
            
            console.log(`âœ… PR created successfully: ${pr.data.html_url}`);
            core.setOutput('pr_url', pr.data.html_url);
            core.setOutput('pr_number', pr.data.number);
            
            // æ·»åŠ æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
            try {
              await github.rest.issues.addLabels({
                owner: upstreamOwner,
                repo: upstreamRepoName,
                issue_number: pr.data.number,
                labels: ['auto-sync', 'from-fork']
              });
            } catch (error) {
              console.log('âš ï¸ Could not add labels:', error.message);
            }
            
          } catch (error) {
            console.error('âŒ Error creating PR:', error);
            core.setFailed(`Failed to create PR: ${error.message}`);
          }

    - name: Comment on original commit
      if: steps.create_pr.outputs.pr_url
      uses: actions/github-script@v7
      with:
        script: |
          const prUrl = '${{ steps.create_pr.outputs.pr_url }}';
          const prNumber = '${{ steps.create_pr.outputs.pr_number }}';
          
          // åœ¨æœ€æ–°æäº¤ä¸Šæ·»åŠ è¯„è®º
          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `ğŸš€ è‡ªåŠ¨å‘ä¸Šæ¸¸ä»“åº“æäº¤äº†PR: [#${prNumber}](${prUrl})`
          });
