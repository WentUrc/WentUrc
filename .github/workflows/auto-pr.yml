name: Auto Submit PR to Upstream

on:
  push:
    branches:
      - main
      # å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–åˆ†æ”¯

env:
  UPSTREAM_REPO: 'WentUrc/WentUrc'  # ä¸Šæ¸¸ä»“åº“ï¼Œæ ¼å¼ï¼šowner/repo
  UPSTREAM_BRANCH: 'main'  # ä¸Šæ¸¸ä»“åº“çš„ç›®æ ‡åˆ†æ”¯

jobs:
  auto-upstream-pr:
    runs-on: ubuntu-latest
    if: github.event.pusher.name != 'IGCrystal-G'  # é¿å…botè§¦å‘çš„å¾ªç¯
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config --global user.name "IGCrystal-G"
        git config --global user.email "cacheigcrystal@gmail.com"

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
        git fetch upstream

    - name: Check if upstream is ahead and sync
      id: check_upstream
      run: |
        # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°çš„æäº¤
        UPSTREAM_COMMITS=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }})
        echo "upstream_commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
        
        if [ "$UPSTREAM_COMMITS" -gt 0 ]; then
          echo "Upstream has $UPSTREAM_COMMITS new commits. Merging upstream changes first."
          git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit || {
            echo "Merge conflict detected. Please resolve manually."
            exit 1
          }
          git push origin ${{ github.ref_name }}
        fi

    - name: Check for changes to submit
      id: check_changes
      run: |
        # æ£€æŸ¥å½“å‰åˆ†æ”¯ç›¸å¯¹äºä¸Šæ¸¸åˆ†æ”¯çš„æäº¤
        AHEAD_COMMITS=$(git rev-list --count upstream/${{ env.UPSTREAM_BRANCH }}..${{ github.ref_name }})
        echo "ahead_commits=$AHEAD_COMMITS" >> $GITHUB_OUTPUT
        
        if [ "$AHEAD_COMMITS" -eq 0 ]; then
          echo "No new commits to submit to upstream."
          exit 0
        fi
        
        echo "Found $AHEAD_COMMITS commits ahead of upstream."

    - name: Push current branch to upstream
      if: steps.check_changes.outputs.ahead_commits > 0
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰UPSTREAM_TOKEN
        if [ -z "${{ secrets.UPSTREAM_TOKEN }}" ]; then
          echo "âŒ UPSTREAM_TOKEN secret not found. Please add it to repository secrets."
          exit 1
        fi
        
        # ä½¿ç”¨UPSTREAM_TOKENæ¨é€å½“å‰åˆ†æ”¯åˆ°ä¸Šæ¸¸ä»“åº“
        git remote remove upstream
        git remote add upstream https://${{ secrets.UPSTREAM_TOKEN }}@github.com/${{ env.UPSTREAM_REPO }}.git
        git push upstream ${{ github.ref_name }}

    - name: Get commit information
      if: steps.check_changes.outputs.ahead_commits > 0
      id: commit_info
      run: |
        # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
        LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        COMMIT_COUNT=${{ steps.check_changes.outputs.ahead_commits }}
        
        echo "last_commit_msg=$LAST_COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "last_commit_author=$LAST_COMMIT_AUTHOR" >> $GITHUB_OUTPUT
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

    - name: Create Pull Request
      if: steps.check_changes.outputs.ahead_commits > 0
      id: create_pr
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.UPSTREAM_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const upstreamRepo = '${{ env.UPSTREAM_REPO }}'.split('/');
          const upstreamOwner = upstreamRepo[0];
          const upstreamRepoName = upstreamRepo[1];
          
          // æ„å»ºPRæ ‡é¢˜å’Œæè¿°
          const commitCount = '${{ steps.commit_info.outputs.commit_count }}';
          const lastCommitMsg = '${{ steps.commit_info.outputs.last_commit_msg }}';
          const lastCommitAuthor = '${{ steps.commit_info.outputs.last_commit_author }}';
          const sourceBranch = '${{ github.ref_name }}';
          
          let title, body;
          
          if (commitCount === '1') {
            title = `${lastCommitMsg}`;
          } else {
            title = `Sync ${commitCount} commits from ${owner}/${repo}:${sourceBranch}`;
          }
          
          body = `## ğŸ”„ è‡ªåŠ¨åŒæ­¥ PR
          
          **æºä»“åº“**: ${owner}/${repo}
          **æºåˆ†æ”¯**: ${sourceBranch}
          **ç›®æ ‡åˆ†æ”¯**: ${{ env.UPSTREAM_BRANCH }}
          **æäº¤æ•°é‡**: ${commitCount}
          **æœ€æ–°æäº¤**: ${lastCommitMsg}
          **æœ€æ–°ä½œè€…**: ${lastCommitAuthor}
          
          ### ğŸ“ å˜æ›´è¯´æ˜
          æ­¤PRè‡ªåŠ¨åŒæ­¥äº†æ¥è‡ªforkä»“åº“çš„${commitCount}ä¸ªæäº¤ã€‚
          
          ### ğŸ” éªŒè¯æ¸…å•
          - [ ] ä»£ç å®¡æŸ¥é€šè¿‡
          - [ ] æµ‹è¯•é€šè¿‡
          - [ ] æ–‡æ¡£æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰
          - [ ] æ— ç ´åæ€§å˜æ›´
          
          ### ğŸ“Š æäº¤å†å²
          `;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„PR
          const existingPRs = await github.rest.pulls.list({
            owner: upstreamOwner,
            repo: upstreamRepoName,
            state: 'open',
            head: `${owner}:${sourceBranch}`,
            base: '${{ env.UPSTREAM_BRANCH }}'
          });
          
          if (existingPRs.data.length > 0) {
            console.log(`â„¹ï¸ PR already exists: ${existingPRs.data[0].html_url}`);
            core.setOutput('pr_url', existingPRs.data[0].html_url);
            core.setOutput('pr_number', existingPRs.data[0].number);
            core.setOutput('pr_existed', 'true');
            return;
          }
          
          // æ·»åŠ æäº¤å†å²
          try {
            const commits = await github.rest.repos.compareCommits({
              owner: upstreamOwner,
              repo: upstreamRepoName,
              base: '${{ env.UPSTREAM_BRANCH }}',
              head: `${owner}:${sourceBranch}`
            });
            
            commits.data.commits.forEach(commit => {
              const shortSha = commit.sha.substring(0, 7);
              const message = commit.commit.message.split('\n')[0];
              const author = commit.commit.author.name;
              body += `\n- \`${shortSha}\` ${message} (@${author})`;
            });
          } catch (error) {
            console.log('âš ï¸ Could not fetch commit history:', error.message);
          }
          
          body += `\n\n---
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºäº ${new Date().toISOString()}*`;
          
          // åˆ›å»ºPR
          try {
            const pr = await github.rest.pulls.create({
              owner: upstreamOwner,
              repo: upstreamRepoName,
              title: title,
              head: `${owner}:${sourceBranch}`,
              base: '${{ env.UPSTREAM_BRANCH }}',
              body: body,
              maintainer_can_modify: true
            });
            
            console.log(`âœ… PR created successfully: ${pr.data.html_url}`);
            core.setOutput('pr_url', pr.data.html_url);
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_existed', 'false');
            
            // æ·»åŠ æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
            try {
              await github.rest.issues.addLabels({
                owner: upstreamOwner,
                repo: upstreamRepoName,
                issue_number: pr.data.number,
                labels: ['auto-sync', 'from-fork']
              });
            } catch (error) {
              console.log('âš ï¸ Could not add labels:', error.message);
            }
            
          } catch (error) {
            console.error('âŒ Error creating PR:', error);
            core.setFailed(`Failed to create PR: ${error.message}`);
          }

    - name: Comment on original commit
      if: steps.create_pr.outputs.pr_url && steps.create_pr.outputs.pr_existed != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const prUrl = '${{ steps.create_pr.outputs.pr_url }}';
          const prNumber = '${{ steps.create_pr.outputs.pr_number }}';
          
          // åœ¨æœ€æ–°æäº¤ä¸Šæ·»åŠ è¯„è®º
          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `ğŸš€ è‡ªåŠ¨å‘ä¸Šæ¸¸ä»“åº“æäº¤äº†PR: [#${prNumber}](${prUrl})`
          });

    - name: Summary
      if: always()
      run: |
        if [ "${{ steps.check_changes.outputs.ahead_commits }}" -eq 0 ]; then
          echo "âœ… æ²¡æœ‰æ–°çš„æäº¤éœ€è¦åŒæ­¥åˆ°ä¸Šæ¸¸ä»“åº“"
        elif [ "${{ steps.create_pr.outputs.pr_existed }}" == "true" ]; then
          echo "â„¹ï¸ PRå·²å­˜åœ¨: ${{ steps.create_pr.outputs.pr_url }}"
        elif [ -n "${{ steps.create_pr.outputs.pr_url }}" ]; then
          echo "âœ… æˆåŠŸåˆ›å»ºPR: ${{ steps.create_pr.outputs.pr_url }}"
        else
          echo "âŒ PRåˆ›å»ºå¤±è´¥"
        fi
