name: Auto Submit PR to Upstream

on:
  push:
    branches:
      - main
      # 可以根据需要添加其他分支

env:
  UPSTREAM_REPO: 'WentUrc/WentUrc'  # 上游仓库，格式：owner/repo
  UPSTREAM_BRANCH: 'main'  # 上游仓库的目标分支

jobs:
  auto-upstream-pr:
    runs-on: ubuntu-latest
    if: github.event.pusher.name != 'IGCrystal-G'  # 避免bot触发的循环
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史记录
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config --global user.name "IGCrystal-G"
        git config --global user.email "cacheigcrystal@gmail.com"

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
        git fetch upstream

    - name: Check if upstream is ahead and sync
      id: check_upstream
      run: |
        # 检查上游是否有新的提交
        UPSTREAM_COMMITS=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }})
        echo "upstream_commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
        
        if [ "$UPSTREAM_COMMITS" -gt 0 ]; then
          echo "Upstream has $UPSTREAM_COMMITS new commits. Merging upstream changes first."
          git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit || {
            echo "Merge conflict detected. Please resolve manually."
            exit 1
          }
          git push origin ${{ github.ref_name }}
        fi

    - name: Check for changes to submit
      id: check_changes
      run: |
        # 检查当前分支相对于上游分支的提交
        AHEAD_COMMITS=$(git rev-list --count upstream/${{ env.UPSTREAM_BRANCH }}..${{ github.ref_name }})
        echo "ahead_commits=$AHEAD_COMMITS" >> $GITHUB_OUTPUT
        
        if [ "$AHEAD_COMMITS" -eq 0 ]; then
          echo "No new commits to submit to upstream."
          exit 0
        fi
        
        echo "Found $AHEAD_COMMITS commits ahead of upstream."

    - name: Push current branch to upstream
      if: steps.check_changes.outputs.ahead_commits > 0
      run: |
        # 检查是否有UPSTREAM_TOKEN
        if [ -z "${{ secrets.UPSTREAM_TOKEN }}" ]; then
          echo "❌ UPSTREAM_TOKEN secret not found. Please add it to repository secrets."
          exit 1
        fi
        
        # 使用UPSTREAM_TOKEN推送当前分支到上游仓库
        git remote remove upstream
        git remote add upstream https://${{ secrets.UPSTREAM_TOKEN }}@github.com/${{ env.UPSTREAM_REPO }}.git
        git push upstream ${{ github.ref_name }}

    - name: Get commit information
      if: steps.check_changes.outputs.ahead_commits > 0
      id: commit_info
      run: |
        # 获取最近的提交信息
        LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        COMMIT_COUNT=${{ steps.check_changes.outputs.ahead_commits }}
        
        echo "last_commit_msg=$LAST_COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "last_commit_author=$LAST_COMMIT_AUTHOR" >> $GITHUB_OUTPUT
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

    - name: Create Pull Request
      if: steps.check_changes.outputs.ahead_commits > 0
      id: create_pr
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.UPSTREAM_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const upstreamRepo = '${{ env.UPSTREAM_REPO }}'.split('/');
          const upstreamOwner = upstreamRepo[0];
          const upstreamRepoName = upstreamRepo[1];
          
          // 构建PR标题和描述
          const commitCount = '${{ steps.commit_info.outputs.commit_count }}';
          const lastCommitMsg = '${{ steps.commit_info.outputs.last_commit_msg }}';
          const lastCommitAuthor = '${{ steps.commit_info.outputs.last_commit_author }}';
          const sourceBranch = '${{ github.ref_name }}';
          
          let title, body;
          
          if (commitCount === '1') {
            title = `${lastCommitMsg}`;
          } else {
            title = `Sync ${commitCount} commits from ${owner}/${repo}:${sourceBranch}`;
          }
          
          body = `## 🔄 自动同步 PR
          
          **源仓库**: ${owner}/${repo}
          **源分支**: ${sourceBranch}
          **目标分支**: ${{ env.UPSTREAM_BRANCH }}
          **提交数量**: ${commitCount}
          **最新提交**: ${lastCommitMsg}
          **最新作者**: ${lastCommitAuthor}
          
          ### 📝 变更说明
          此PR自动同步了来自fork仓库的${commitCount}个提交。
          
          ### 🔍 验证清单
          - [ ] 代码审查通过
          - [ ] 测试通过
          - [ ] 文档更新（如需要）
          - [ ] 无破坏性变更
          
          ### 📊 提交历史
          `;
          
          // 检查是否已存在相同的PR
          const existingPRs = await github.rest.pulls.list({
            owner: upstreamOwner,
            repo: upstreamRepoName,
            state: 'open',
            head: `${owner}:${sourceBranch}`,
            base: '${{ env.UPSTREAM_BRANCH }}'
          });
          
          if (existingPRs.data.length > 0) {
            console.log(`ℹ️ PR already exists: ${existingPRs.data[0].html_url}`);
            core.setOutput('pr_url', existingPRs.data[0].html_url);
            core.setOutput('pr_number', existingPRs.data[0].number);
            core.setOutput('pr_existed', 'true');
            return;
          }
          
          // 添加提交历史
          try {
            const commits = await github.rest.repos.compareCommits({
              owner: upstreamOwner,
              repo: upstreamRepoName,
              base: '${{ env.UPSTREAM_BRANCH }}',
              head: `${owner}:${sourceBranch}`
            });
            
            commits.data.commits.forEach(commit => {
              const shortSha = commit.sha.substring(0, 7);
              const message = commit.commit.message.split('\n')[0];
              const author = commit.commit.author.name;
              body += `\n- \`${shortSha}\` ${message} (@${author})`;
            });
          } catch (error) {
            console.log('⚠️ Could not fetch commit history:', error.message);
          }
          
          body += `\n\n---
          *此PR由GitHub Actions自动创建于 ${new Date().toISOString()}*`;
          
          // 创建PR
          try {
            const pr = await github.rest.pulls.create({
              owner: upstreamOwner,
              repo: upstreamRepoName,
              title: title,
              head: `${owner}:${sourceBranch}`,
              base: '${{ env.UPSTREAM_BRANCH }}',
              body: body,
              maintainer_can_modify: true
            });
            
            console.log(`✅ PR created successfully: ${pr.data.html_url}`);
            core.setOutput('pr_url', pr.data.html_url);
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_existed', 'false');
            
            // 添加标签（可选）
            try {
              await github.rest.issues.addLabels({
                owner: upstreamOwner,
                repo: upstreamRepoName,
                issue_number: pr.data.number,
                labels: ['auto-sync', 'from-fork']
              });
            } catch (error) {
              console.log('⚠️ Could not add labels:', error.message);
            }
            
          } catch (error) {
            console.error('❌ Error creating PR:', error);
            core.setFailed(`Failed to create PR: ${error.message}`);
          }

    - name: Comment on original commit
      if: steps.create_pr.outputs.pr_url && steps.create_pr.outputs.pr_existed != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const prUrl = '${{ steps.create_pr.outputs.pr_url }}';
          const prNumber = '${{ steps.create_pr.outputs.pr_number }}';
          
          // 在最新提交上添加评论
          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `🚀 自动向上游仓库提交了PR: [#${prNumber}](${prUrl})`
          });

    - name: Summary
      if: always()
      run: |
        if [ "${{ steps.check_changes.outputs.ahead_commits }}" -eq 0 ]; then
          echo "✅ 没有新的提交需要同步到上游仓库"
        elif [ "${{ steps.create_pr.outputs.pr_existed }}" == "true" ]; then
          echo "ℹ️ PR已存在: ${{ steps.create_pr.outputs.pr_url }}"
        elif [ -n "${{ steps.create_pr.outputs.pr_url }}" ]; then
          echo "✅ 成功创建PR: ${{ steps.create_pr.outputs.pr_url }}"
        else
          echo "❌ PR创建失败"
        fi
